"use strict";function PacmanGame(a,b){this.parent=a,this.term=null,this.termConfig={hud:{x:3,y:1},gameArea:{x:3,y:3}},this.gameOver=!0,this.score=0,this.highScore=b||0,this.totalPoints=0,this.countPoints=0,this.p1=null,this.ghosts=null,this.map=null,this.TilePacmanLeft=[new ut.Tile(">",255,255,0),new ut.Tile("-",255,255,0)],this.TilePacmanRight=[new ut.Tile("<",255,255,0),new ut.Tile("-",255,255,0)],this.TilePacmanUp=[new ut.Tile("V",255,255,0),new ut.Tile("|",255,255,0)],this.TilePacmanDown=[new ut.Tile("^",255,255,0),new ut.Tile("|",255,255,0)],this.TilePoint=new ut.Tile("▪",150,0,150),this.TileBigP=new ut.Tile("O",150,0,150),this.TileWall=new ut.Tile(" ",0,0,0,100,100,100),this.TileEmpty=new ut.Tile(" ",100,100,100);var c=PacmanGame.HudColors.BG;this.TileHudBG=new ut.Tile(" ",0,0,0,c.r,c.g,c.b),this.onPacmanMove=null}function restartGame(a,b){var c=new PacmanGame(a,b),d=Bacon.fromBinder(function(a){c.onPacmanMove=function(b){a(b)}});d.onValue(function(b){return b?void c.movePacman(b):void restartGame(a,c.highScore)});var e=Bacon.sequentially(800,[PacmanGame.GhostColors.ORANGE,PacmanGame.GhostColors.BLUE,PacmanGame.GhostColors.GREEN,PacmanGame.GhostColors.PURPLE,PacmanGame.GhostColors.WHITE]).delay(2500);e.onValue(function(a){c.spawnGhost(a)});var f=Bacon.interval(1e3,0);f.subscribe(function(){c.updateGhosts()});var g=new Bacon.Bus;g.plug(d),g.plug(f),g.subscribe(function(){c.tick()}),c.start()}PacmanGame.HudColors={BG:{r:94,g:39,b:40}},PacmanGame.GhostColors={ORANGE:1,BLUE:2,GREEN:3,PURPLE:4,WHITE:5},PacmanGame.PacmanTiles={WALL:"#",POINT:".",BIGP:"o",EMPTY:" "},PacmanGame.prototype.generateMap=function(){this.p1={x:14,y:12,tile:this.TilePacmanLeft[0]},this.ghosts=[],this.map=["############################","#o...........##...........o#","#.####.#####.##.#####.####.#","#.####.#####.##.#####.####.#","#..........................#","#.####.#.##########.#.####.#","#......#.....##.....#......#","######.#####.##.#####.######","     #.#............#.#     ","######.#.####  ####.#.######",".........#        #.........","######.#.##########.#.######","     #.#............#.#     ","######.#.##########.#.######","#............##............#","#.####.#####.##.#####.####.#","#...##................##...#","###.##.#.##########.#.##.###","#......#.....##.....#......#","#.##########.##.##########.#","#o........................o#","############################"];var a=0;this.map.forEach(function(b){a+=b.split(".").length-1}),this.totalPoints=a,this.wrapPos=[{x:-1,y:10,wrapTo:{x:27,y:10}},{x:28,y:10,wrapTo:{x:0,y:10}}]},PacmanGame.prototype.getGhostTile=function(a){var b,c="X";switch(a){case PacmanGame.GhostColors.ORANGE:b=new ut.Tile(c,150,75,0);break;case PacmanGame.GhostColors.BLUE:b=new ut.Tile(c,0,0,100);break;case PacmanGame.GhostColors.GREEN:b=new ut.Tile(c,0,100,0);break;case PacmanGame.GhostColors.PURPLE:b=new ut.Tile(c,100,0,100);break;case PacmanGame.GhostColors.WHITE:b=new ut.Tile(c,255,255,255)}return b},PacmanGame.prototype.getPacmanTile=function(a,b){var c="";try{c=this.map[b][a]}catch(d){return ut.NULLTILE}switch(c){case PacmanGame.PacmanTiles.POINT:return this.TilePoint;case PacmanGame.PacmanTiles.BIGP:return this.TileBigP;case PacmanGame.PacmanTiles.WALL:return this.TileWall;case PacmanGame.PacmanTiles.EMPTY:return this.TileEmpty;default:return ut.NULLTILE}},PacmanGame.prototype.setPacmanTile=function(a,b,c){var d=this.map[b];this.map[b]=d.substr(0,a)+c+d.substr(a+1)},PacmanGame.prototype.setGameOver=function(){this.p1.tile=new ut.Tile("Ⴖ",255,255,255),this.gameOver=!0,this.highScore=Math.max(this.highScore,this.score)},PacmanGame.prototype.putHud=function(){for(var a=this.termConfig.hud,b=0;b<this.map[0].length;b++)for(var c=0;2>c;c++)this.term.put(this.TileHudBG,a.x+b,a.y+c);var d=PacmanGame.HudColors.BG,e=this.map[0].length/2;if(this.term.putString("High Score",a.x+e,a.y,255,255,255,d.r,d.g,d.b),this.term.putString(this.score.toString(),a.x+2,a.y+1,255,255,255,d.r,d.g,d.b),this.term.putString(this.highScore.toString(),a.x+e,a.y+1,255,255,255,d.r,d.g,d.b),this.gameOver){var f=this.map.length;this.term.putString("Game Over",a.x,a.y+f+2,255,255,255,d.r,d.g,d.b),this.term.putString("Space to Restart",a.x,a.y+f+3,255,255,255,d.r,d.g,d.b)}},PacmanGame.prototype.putTiles=function(){for(var a=this.termConfig.gameArea,b=0;b<this.map.length;b++)for(var c=0;c<this.map[0].length;c++)this.term.put(this.getPacmanTile(c,b),a.x+c,a.y+b)},PacmanGame.prototype.putMovables=function(){var a=this.termConfig.gameArea;this.term.put(this.p1.tile,a.x+this.p1.x,a.y+this.p1.y);for(var b in this.ghosts){var c=this.ghosts[b];this.term.put(c.tile,a.x+c.x,a.y+c.y)}},PacmanGame.prototype.movePacman=function(a){var b={x:this.p1.x+a.x,y:this.p1.y+a.y,tile:this.TilePacmanDown};if(!this.gameOver){if(!this.canMoveTo(b.x,b.y)){var c=this.findWrapPos(b.x,b.y);if(!c)return;b.x=c.x,b.y=c.y}a.x<0?b.tile=this.TilePacmanLeft:a.x>0?b.tile=this.TilePacmanRight:a.y<0&&(b.tile=this.TilePacmanUp),b.tile=b.tile[0]===this.p1.tile?b.tile[1]:b.tile[0],this.p1=b}},PacmanGame.prototype.spawnGhost=function(a){var b={x:14,y:10,tile:this.getGhostTile(a),v:{x:0,y:-1}};this.ghosts.push(b)},PacmanGame.prototype.moveGhost=function(a){var b=this.findWrapPos(a.x+a.v.x,a.y+a.v.y);if(b)return a.x=b.x,void(a.y=b.y);var c=this.availableDirections(a.x,a.y),d={x:-1*a.v.x,y:-1*a.v.y};c.length>1&&(c=c.filter(function(a){return a.x!==d.x||a.y!==d.y}));var e=Math.floor(Math.random()*(c.length-1));a.v=c[e],a.x+=a.v.x,a.y+=a.v.y},PacmanGame.prototype.availableDirections=function(a,b){var c=[];return[{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}].forEach(function(d){this.canMoveTo(a+d.x,b+d.y)&&c.push(d)},this),c},PacmanGame.prototype.canMoveTo=function(a,b){var c=this.getPacmanTile(a,b);return c===this.TilePoint||c===this.TileBigP||c===this.TileEmpty},PacmanGame.prototype.findWrapPos=function(a,b){var c=this.wrapPos.filter(function(c){return c.x===a&&c.y===b});return c.length>0?c[0].wrapTo:null},PacmanGame.prototype.checkPacmanEat=function(){var a=this.getPacmanTile(this.p1.x,this.p1.y);a===this.TilePoint?(this.setPacmanTile(this.p1.x,this.p1.y,PacmanGame.PacmanTiles.EMPTY),this.score++,this.countPoints++,this.countPoints===this.totalPoints&&(this.score+=100,this.setGameOver())):a===this.TileBigP&&(this.setPacmanTile(this.p1.x,this.p1.y,PacmanGame.PacmanTiles.EMPTY),this.score+=10)},PacmanGame.prototype.checkPacmanCaught=function(){var a=this,b=this.p1;this.ghosts.forEach(function(c){c.x===b.x&&c.y===b.y&&a.setGameOver()})},PacmanGame.prototype.updateGhosts=function(){this.ghosts.forEach(function(a){this.moveGhost(a)},this)},PacmanGame.prototype.tick=function(){this.gameOver||(this.checkPacmanEat(),this.checkPacmanCaught()),this.putHud(),this.putTiles(),this.putMovables(),this.term.render()},PacmanGame.prototype.onKeyDown=function(a){var b={x:0,y:0};switch(a){case ut.KEY_W:b.y--;break;case ut.KEY_A:b.x--;break;case ut.KEY_S:b.y++;break;case ut.KEY_D:b.x++;break;case ut.KEY_SPACE:this.gameOver&&(b=null)}"function"==typeof this.onPacmanMove&&this.onPacmanMove(b)},PacmanGame.prototype.start=function(){this.gameOver=!1,this.generateMap(),this.term=new ut.Viewport(this.parent,50,30),ut.initInput(this.onKeyDown.bind(this)),this.tick()},$(document).ready(function(){restartGame($(".game-area")[0])});