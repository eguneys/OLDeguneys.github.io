
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->

<head>


<meta charset="utf-8">
<meta http-equiv="cleartype" content="on">

<title>Building a Voting App: REST API /w Sequelize - Fullstack Development w/ Javascript</title>
<meta name="author" content="Emre Guneyler">




<meta name="description" content="Blog about javascript, nodejs, emberjs, backbone, requirejs, yeoman, phaser, web development, game development, and anything that interests me about &hellip;">

<meta name="keywords" content="backend nodejs rest sequelize javascript nodejs emberjs backbone phaser requirejs yeoman web-development game-development">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Twitter Cards -->

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/images/diary-bg20.jpg"
  
  <meta name="twitter:title" content="Building a Voting App: REST API /w Sequelize">
  <meta name="twitter:description" content="Blog about javascript, nodejs, emberjs, backbone, requirejs, yeoman, phaser, web development, game development, and anything that interests me about &hellip;">
  <meta name="twitter:creator" content="@eguneys">


<!-- Open Graph -->
<meta property="og:local" content="en_US">
<meta property="og:type" content="article">
<meta property="og:url" content="http://www.eguneys.com/blog/2014/09/17/building-a-voting-app-rest-api-slash-w-sequelize">
<meta property="og:title" content="Building a Voting App: REST API /w Sequelize">
<meta property="og:description" content="Blog about javascript, nodejs, emberjs, backbone, requirejs, yeoman, phaser, web development, game development, and anything that interests me about &hellip;">

  <meta property="og:image" content="/images/diary-bg20.jpg">

<meta property="og:site_name" content="Fullstack Development w/ Javascript">

<link rel="canonical" href="http://www.eguneys.com/blog/2014/09/17/building-a-voting-app-rest-api-slash-w-sequelize">
<link href="/favicon.png" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/atom.xml" rel="alternate" title="Fullstack Development w/ Javascript" type="application/atom+xml">

<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
<script>Modernizr || document.write('<script src="/javascripts/vendor/modernizr-2.6.2.custom.min.js"><\/script>') </script>


  
      
  

  
    
  

  <style type="text/css">body {background-image:url(/images/colorflags-bg.jpg);}</style>


<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar.jpg" alt="Emre Guneyler photo" class="author-photo">
					<h4>Emre Guneyler</h4>
					<p>Fullstack Hipster</p>
				</li>
				<li><a href="/about">Learn More</a></li>-
				
				<li>
					<a href="http://twitter.com/eguneys"><i class="fa fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="http://plus.google.com/eguneys"><i class="fa fa-google-plus"></i> Google+</a>
				</li>
				<li>
					<a href="http://github.com/eguneys"><i class="fa fa-github"></i> GitHub</a>
				</li>
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/categories/">All Categories</a></li>
			</ul>
		</li>
		<li><a href="http://jsgamesonline.com">JS Games</a></li>
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    <img src="/images/diary-bg20.jpg" alt="Building a Voting App: REST API /w Sequelize">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/blog/2014/09/17/building-a-voting-app-rest-api-slash-w-sequelize/" rel="bookmark" title="Building a Voting App: REST API /w Sequelize">Building a Voting App: REST API /w Sequelize</a></h1>
        
        <h2>September 17, 2014</h2>
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <h2>Introduction</h2>

<p><a href="http://sequelizejs.com">Sequelize</a> is an ORM (Object Relational Mapper) for NodeJS that provides easy access to various databases like MySQL, MariaDB, SQLite, or PostgreSQL.</p>

<p>It has a nice website with helpful documentation and <a href="https://github.com/sequelize/sequelize/tree/master/examples">examples</a> to get started. Also there is an IRC channel #sequelizejs on Freenode.</p>

<p>In this article we will build a voting application where users can vote for a poll and we will record their <code>IP</code> so they cannot vote twice. We will use <code>sequelize</code> to model our data and build a <code>REST API</code>. Later we will build the front end using <code>emberjs</code>.</p>

<h2>Scaffold Voting Application</h2>

<p>Since we are using <code>emberjs</code> we might use <code>ember-cli</code> for our project. But, yet recently I published a yeoman generator <a href="https://github.com/eguneys/generator-emberfs">generator-emberfs</a> for emberjs fullstack projects like the one we are building now. It does all the scaffolding for emberjs on the client side and expressjs on the server side. So we will use it for this article.</p>

<p>You can install using the command:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">npm install -g generator-emberfs
  yo emberfs</code></pre></div>


<h3>Directory Structure</h3>

<p>This is our directory structure for voting application. <code>config</code> folder contains the initial server code and configuration files. <code>app/models</code>, <code>app/routes</code> and <code>app/views</code> folders contain our server side models, routes, and views respectively. <code>db</code> folder is for the sqlite database file and code for our database seed.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">.
<span class="p">|</span>-- app
<span class="p">|</span>   <span class="p">|</span>-- models
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- index.js
<span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- poll.js
<span class="p">|</span>   <span class="p">|</span>-- routes
<span class="p">|</span>   <span class="p">|</span>-- <span class="sb">`</span>-- api.js
<span class="p">|</span>   <span class="sb">`</span>-- views
<span class="p">|</span>       <span class="sb">`</span>-- layouts
<span class="p">|</span>-- config
<span class="p">|</span>   <span class="p">|</span>-- app.js
<span class="p">|</span>   <span class="sb">`</span>-- server.js
<span class="p">|</span>
<span class="sb">`</span>-- db
    <span class="p">|</span>-- development.sqlite
    <span class="sb">`</span>-- seed.js</code></pre></div>


<p>We will define only routes for the REST API so we won&rsquo;t mention about the <code>app/views</code> folder here.</p>

<p>Note that this folder structure is boilerplate for the <code>generator-emberfs</code>. So you won&rsquo;t need to do the tedious work if you use it.</p>

<h2>Models in Sequelize</h2>

<p>This is our model diagram. <em>Poll</em> is a <em>question</em> and has many <em>Choices</em>. <em>Choice</em> is a poll choice with a <em>text</em> and <em>description</em> and has many <em>Votes</em>. <em>Vote</em> has an <em>ip</em> that identifies the voter, so we can make sure one ip can vote only once.</p>

<p><a href="vote_diagram.png">image</a></p>

<p>All our models are in file <code>app/models/poll.js</code>. Later we will import them.</p>

<p><strong>Vote</strong> model is simple, just a single field <code>ip</code> and has no relationships. It also has some helpers methods which I will mention later.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">Vote</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;Vote&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">ip</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span>
    <span class="c1">// ... define model fields here</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="nx">classMethods</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">associate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// define relationships here</span>
      <span class="p">}</span>
        <span class="c1">// ... define class methods here</span>
    <span class="p">}</span>
  <span class="p">});</span></code></pre></div>


<p><strong>Choice</strong> model has two fields, <code>text</code> and <code>description</code>, and has one-to-many relationship with the <em>Vote</em> model. We define the relationships in a class method named <em>associate</em>.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">Choice</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;Choice&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">text</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
    <span class="nx">description</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="nx">classMethods</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">associate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Choice</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">Vote</span><span class="p">,</span> <span class="p">{</span> <span class="nx">as</span> <span class="o">:</span> <span class="s1">&#39;votes&#39;</span> <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span></code></pre></div>


<p><strong>Poll</strong> model has one field <em>question</em>, and has one-to-many relationship with the <em>Choice</em> model.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">Poll</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;Poll&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">question</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="nx">classMethods</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">associate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Poll</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">Choice</span><span class="p">,</span> <span class="p">{</span> <span class="nx">as</span><span class="o">:</span> <span class="s1">&#39;choices&#39;</span> <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span></code></pre></div>


<h3>Import all models in Sequelize</h3>

<p>Now we have defined our models, we need to import them with sequelize. We will do that in file <code>app/models/index.js</code>.</p>

<p>In our example we have only one file defining our models namely <code>app/models/poll.js</code>. But we can have more than that, and we will import all the files in <code>app/models</code> folder.</p>

<p>First let&rsquo;s require our dependencies, and initialize Sequelize. <code>votes-app-db</code> is the name of our database.</p>

<p>We are using <code>sqlite</code> for the database and <code>./db/development.sqlite</code> file for the database. <code>sqlite</code> is a zero-configuration, serverless database. It works directly from the database files on disk.</p>

<p><code>File: app/models/index.js</code></p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
  <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
  <span class="nx">lodash</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">),</span>
  <span class="nx">Sequelize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sequelize&#39;</span><span class="p">),</span>
  <span class="nx">sequelize</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">db</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="s1">&#39;votes-app-db&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">dialect</span><span class="o">:</span> <span class="s1">&#39;sqlite&#39;</span><span class="p">,</span>
  <span class="nx">storage</span><span class="o">:</span> <span class="s1">&#39;./db/development.sqlite&#39;</span>
<span class="p">});</span></code></pre></div>


<p>Before we import the models, let&rsquo;s see how we export our models in <code>app/models/poll.js</code>.</p>

<p><code>File: app/models/poll.js</code></p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">Sequelize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sequelize&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// I omit the definitions.</span>
  <span class="kd">var</span> <span class="nx">Vote</span><span class="p">,</span> <span class="nx">Poll</span><span class="p">,</span> <span class="nx">Choice</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">[</span><span class="nx">Vote</span><span class="p">,</span> <span class="nx">Poll</span><span class="p">.</span> <span class="nx">Choice</span><span class="p">];</span>
<span class="p">};</span></code></pre></div>


<p>We export an array of our models. Now let&rsquo;s import each file in <code>app/models</code> to sequelize.</p>

<p><code>File: app/models/index.js</code></p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">file</span> <span class="o">!==</span> <span class="s1">&#39;index.js&#39;</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="nx">file</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">model</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">db</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">m</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span></code></pre></div>


<p>We filter out the <code>index.js</code> and import every file to sequelize. Later we keep references to our models in <code>db</code> object. Note that our model files can both return an array or a single object, that&rsquo;s what the <em>if</em> condition is checking for.</p>

<p>Finally we call the <code>associate</code> class method for each model that will define the relationships between models. Then we export all the models (<code>db</code> object) along with sequelize.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">modelName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;associate&#39;</span> <span class="k">in</span> <span class="nx">db</span><span class="p">[</span><span class="nx">modelName</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">[</span><span class="nx">modelName</span><span class="p">].</span><span class="nx">associate</span><span class="p">(</span><span class="nx">db</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">lodash</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">sequelize</span><span class="o">:</span> <span class="nx">sequelize</span><span class="p">,</span>
  <span class="nx">Sequelize</span><span class="o">:</span> <span class="nx">Sequelize</span>
<span class="p">},</span> <span class="nx">db</span><span class="p">);</span></code></pre></div>


<h3>Seed for the Database</h3>

<p>Next, we seed the database a sample poll with two choices.</p>

<p><code>File: db/seed.js</code></p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">db</span><span class="p">.</span><span class="nx">Poll</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
    <span class="nx">question</span><span class="o">:</span> <span class="s1">&#39;What features would you like to see&#39;</span>
  <span class="p">}).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">poll</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">Choice</span><span class="p">.</span><span class="nx">bulkCreate</span><span class="p">([{</span>
      <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Improved UI&#39;</span><span class="p">,</span>
      <span class="nx">description</span><span class="o">:</span> <span class="s1">&#39;New, fancy interface&#39;</span><span class="p">,</span>
      <span class="nx">PollId</span><span class="o">:</span> <span class="nx">poll</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Improved Performance&#39;</span><span class="p">,</span>
      <span class="nx">description</span><span class="o">:</span> <span class="s1">&#39;Faster response times&#39;</span><span class="p">,</span>
      <span class="nx">PollId</span><span class="o">:</span> <span class="nx">poll</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">}]);</span>
  <span class="p">});</span>

<span class="p">};</span></code></pre></div>


<p>Note that each model has a <code>create</code> and <code>bulkCreate</code> function. The difference is <code>create</code> takes a single object and <code>bulkCreate</code> takes an array of objects.</p>

<p>One final thing is the <em>choice</em> model instances has an extra attribute, <em>PollId</em>, that is the foreign key referencing the <em>Poll</em> model.</p>

<h3>Helper methods for Models</h3>

<p>We will define two helper methods for the <em>Vote</em> model. They are both defined under the <em>classMethods</em> object (near to <em>associate</em> method).</p>

<p><strong>findCount</strong> method takes a <em>choiceId</em> and finds the number of votes for that choice.</p>

<p><code>File: app/models/poll.js</code></p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">findCount</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">choiceId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Vote</span><span class="p">.</span><span class="nx">count</span><span class="p">({</span>
      <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;ChoiceId&#39;</span><span class="o">:</span> <span class="nx">choiceId</span><span class="p">}</span>
    <span class="p">}).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span></code></pre></div>


<p><strong>addVote</strong> method takes an <em>ip</em> and a <em>choice</em> and creates a new vote. The trick here is that we have to make sure the given ip doesn&rsquo;t vote twice for the same poll. So we need a nifty sql statement to &ldquo;select all the votes for the poll that the given choice belongs to and that is the same ip as the given ip&rdquo;. This statement will return a single vote if the given ip has voted for the same poll or null if it hasn&rsquo;t.</p>

<p><code>File: app/models/poll.js</code></p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">addVote</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ip</span><span class="p">,</span> <span class="nx">choice</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// sequelize translation of the sql command:</span>
    <span class="c1">//</span>
    <span class="c1">// select * from votes, choices, polls where</span>
    <span class="c1">// votes.choiceId == choices.id and choices.pollId ==</span>
    <span class="c1">// polls.id and choices.id == choice polls.id in</span>
    <span class="c1">// (select pollId from votes, choices where</span>
    <span class="c1">// votes.choiceId == choices.id and votes.ip == ip)</span>
                
    <span class="nx">Poll</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span> <span class="nx">where</span><span class="o">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">and</span><span class="p">(</span>
      <span class="p">{</span>
        <span class="s1">&#39;choices.id&#39;</span><span class="o">:</span> <span class="nx">choice</span>
      <span class="p">},</span>
      <span class="p">{</span><span class="nx">id</span><span class="o">:</span> 
        <span class="p">{</span> <span class="k">in</span><span class="o">:</span>
          <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">literal</span><span class="p">(</span><span class="s1">&#39;select &quot;Choices&quot;.&quot;PollId&quot; from &quot;Votes&quot;, &quot;Choices&quot; where &quot;Votes&quot;.&quot;ChoiceId&quot; = &quot;Choices&quot;.&quot;id&quot; and &quot;Votes&quot;.&quot;ip&quot; = \&#39;&#39;</span> <span class="o">+</span> <span class="nx">ip</span> <span class="o">+</span> <span class="s1">&#39;\&#39;&#39;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}),</span>
        <span class="nx">include</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Choice</span><span class="p">,</span> <span class="nx">as</span><span class="o">:</span> <span class="s1">&#39;choices&#39;</span><span class="p">,</span>
          <span class="nx">include</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">Vote</span><span class="p">,</span> <span class="nx">as</span><span class="o">:</span> <span class="s1">&#39;votes&#39;</span> <span class="p">}]}]</span>
      <span class="p">}).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">votes</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">votes</span> <span class="o">||</span> <span class="nx">votes</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">Vote</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="nx">ip</span><span class="o">:</span> <span class="nx">ip</span><span class="p">,</span>
            <span class="nx">ChoiceId</span><span class="o">:</span> <span class="nx">choice</span>
          <span class="p">})</span>
            <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">vote</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">vote</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="s2">&quot;Vote already exists&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
  <span class="p">},</span></code></pre></div>


<p>I am sure there is a better way to build this statement in sequelize, but this works too. Note that we make use of <code>Sequelize.literal</code> method that interprets the raw sql command.</p>

<p>Finally upon success, if the vote already exists, we give error, otherwise we create a new vote which builds and saves the vote to the database.</p>

<h2>Routes for Express 4</h2>

<p>Routing in Express 4 is modular and mountable. A <code>Router</code> instance is a complete middleware. But, yet I won&rsquo;t get into detail how to use express routers in this article. For more information check out the express <a href="http://expressjs.com">docs</a> and the <a href="http://expressjs.com/migrating-4.html#routing">migration guide</a>.</p>

<p>All our API routes are in file <code>app/routes/api.js</code>.</p>

<p><code>/polls</code> route lists all the available polls.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/polls&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">Poll</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span>
      <span class="c1">// you can include choices for the poll, or not.</span>
      <span class="c1">//include: [{ model: db.Choice, as: &#39;choices&#39; }]</span>
    <span class="p">}).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">polls</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
        <span class="nx">polls</span><span class="o">:</span> <span class="nx">polls</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span></code></pre></div>


<p>Note that <code>include</code> option enables us to embed the <em>choices</em> for the poll. In our case we opt not to.</p>

<p><code>/polls/:id</code> route gets a single poll with a given id. This time we <em>include</em> the choices for the poll as well. The trick here is for each choice we find the number of votes for that choice, and include the count in the choice model using the <code>setDataValue</code> method.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/polls/:id&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">Poll</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
      <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="p">},</span>
      <span class="nx">include</span><span class="o">:</span> <span class="p">[{</span><span class="nx">model</span><span class="o">:</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Choice</span><span class="p">,</span> <span class="nx">as</span><span class="o">:</span> <span class="s1">&#39;choices&#39;</span> <span class="p">}]</span>
    <span class="p">}).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">poll</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">async</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">poll</span><span class="p">.</span><span class="nx">choices</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">choice</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">Vote</span><span class="p">.</span><span class="nx">findCount</span><span class="p">(</span><span class="nx">choice</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">choice</span><span class="p">.</span><span class="nx">setDataValue</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">choice</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">poll</span><span class="p">.</span><span class="nx">setDataValue</span><span class="p">(</span><span class="s1">&#39;choices&#39;</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
          <span class="nx">poll</span><span class="o">:</span> <span class="nx">poll</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span></code></pre></div>


<p>Note that we use <em>async</em> library to map <em>poll.choices</em> and add the vote count for each choice. Later we use <code>setDataValue</code> method for the poll model to set the <em>choices</em> to the map results.</p>

<p>We post to <code>/votes</code> route to make a vote. One ip can vote for a poll only once, thanks to our <em>addVote</em> helper method.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/votes&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ip</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;x-forwarded-for&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">;</span>
    <span class="c1">// randomize the ip to test your app</span>
    <span class="c1">//ip = Math.random();</span>
        
    <span class="kd">var</span> <span class="nx">choice</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">vote</span><span class="p">.</span><span class="nx">choice</span><span class="p">;</span>
        
    <span class="nx">db</span><span class="p">.</span><span class="nx">Vote</span><span class="p">.</span><span class="nx">addVote</span><span class="p">(</span><span class="nx">ip</span><span class="p">,</span> <span class="nx">choice</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">vote</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">vote</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span></code></pre></div>


<p>Note that we use <code>x-forwarded-for</code> header or the <code>req.connection.remoteAddress</code> to get the ip. If you want to test the application so you can have many votes, randomize the ip with <code>Math.random</code>.</p>

<p>Finally <code>/votes/:choiceId</code> route will return the number of votes for a given choice.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/votes/:choiceId&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">choice</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">choiceId</span><span class="p">;</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">Vote</span><span class="p">.</span><span class="nx">findCount</span><span class="p">(</span><span class="nx">choice</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">vote</span><span class="o">:</span> <span class="nx">count</span> <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span></code></pre></div>


<h2>Setup the Server</h2>

<p>Finally we start sequelize, seed the database, and fire up the express server.</p>

<p><code>File: app/config/app.js</code></p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./server&#39;</span><span class="p">),</span>
  <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../app/models&#39;</span><span class="p">);</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">sequelize</span>
  <span class="p">.</span><span class="nx">sync</span><span class="p">({</span> <span class="nx">force</span><span class="o">:</span> <span class="kc">true</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">complete</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nx">err</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// seed</span>
      <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../db/seed&#39;</span><span class="p">)(</span><span class="nx">db</span><span class="p">);</span>
      
      <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;express listening on &#39;</span> <span class="o">+</span> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">));</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span></code></pre></div>


<p>Note that we require <code>../app/models</code> that exports all the <em>models</em> and <em>sequelize</em> as the <em>db</em> object. Also we require <code>./server</code> that exports the express application. I won&rsquo;t mention about configuring and setting up the express server, it&rsquo;s simple enough and you should do it however you like. For more details check out the full repository at <a href="https://www.github.com/eguneys/voting_app">github</a>.</p>

<h2>Conclusion</h2>

<p>In this article we have built a <code>REST API</code> using <code>sequelize</code> for voting polls. We&rsquo;ve setup models in <code>sequelize</code> provided seed for the database, used query methods for the models, and setup the API routes for the <code>express</code> server. Next up we will build the front end using <code>emberjs</code>.</p>

<p>The full repository is at <a href="https://www.github.com/eguneys/voting_app">github</a>.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/categories/#backend" title="Pages tagged backend" class="tag">backend</a><a href="/categories/#nodejs" title="Pages tagged nodejs" class="tag">nodejs</a><a href="/categories/#rest" title="Pages tagged rest" class="tag">rest</a><a href="/categories/#sequelize" title="Pages tagged sequelize" class="tag">sequelize</a></span>
        <span><a href="/blog/2014/09/17/building-a-voting-app-rest-api-slash-w-sequelize/" rel="bookmark" title="Building a Voting App: REST API /w Sequelize">Building a Voting App: REST API /w Sequelize</a> was published on <span class="entry-date date published updated"><time datetime="2014-09-17T12:15:56+03:00">September 17, 2014</time></span></span>
        
        <span class="author vcard"><span class="fn"><a href="" title="About Emre Guneyler">Emre Guneyler</a></span></span>
        
      </footer>
    </div><!-- /.entry-content -->
    
      <div class="read-more">
        
          <div class="read-more-header">
            <a href="/blog/2014/09/17/building-a-voting-app-front-end-slash-w-ember/" class="btn">Read More</a>
          </div><!-- /.read-more-header -->
          <div class="read-more-content">
            <h3><a href="/blog/2014/09/17/building-a-voting-app-front-end-slash-w-ember/" title="Building a Voting App: Front-end /w ember">Building a Voting App: Front-end /w ember</a></h3>
            <p>## IntroductionIn the [previous article](/blog/2014/09/17/building-a-voting-app-rest-api-slash-w-sequelize/) we&#8217;ve built a REST API for a &hellip;&hellip; <a href="/blog/2014/09/17/building-a-voting-app-front-end-slash-w-ember/"> Continue reading</a></p>
          </div><!-- /.read-more-content -->
        
        <div class="read-more-list">
          
            <div class="list-item">
              <h4><a href="/blog/2014/09/17/lets-build-a-yeoman-generator-2/" title="Let's Build a Yeoman Generator 2">Let&#8217;s Build a Yeoman Generator 2</a></h4>
              <span>Published on September 17, 2014</span>
            </div><!-- /.list-item -->
          
            <div class="list-item">
              <h4><a href="/blog/2014/09/17/lets-build-a-yeoman-generator-project-template-slash-w-gulp/" title="Let's Build a Yeoman Generator: Project Template /w gulp">Let&#8217;s Build a Yeoman Generator: Project Template /w gulp</a></h4>
              <span>Published on September 17, 2014</span>
            </div><!-- /.list-item -->
          
        </div><!-- /.read-more-list -->
      </div><!-- /.read-more -->
    
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2014 Emre Guneyler. Powered by <a href="http://octopress.org">Octopress</a> using the <a href="https://github.com/Z1MM32M4N/hpstr-theme/">HPSTR Theme for Octopress</a>.</span>

  </footer>
</div><!-- /.footer-wrapper -->


	        
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/javascripts/vendor/jquery-1.9.1.min.js"><\/script>')</script>

<script src="/javascripts/octopress.js" type="text/javascript"></script>

<script src="/javascripts/scripts.min.js"></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42906606-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>




<script type="text/javascript">
      var disqus_shortname = 'eguneys';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.eguneys.com/blog/2014/09/17/building-a-voting-app-rest-api-slash-w-sequelize/';
        var disqus_url = 'http://www.eguneys.com/blog/2014/09/17/building-a-voting-app-rest-api-slash-w-sequelize/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


	        

</body>
</html>
